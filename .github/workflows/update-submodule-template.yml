name: Update Template Files

on:
  repository_dispatch:
    types: [update-templates]

jobs:
  update-templates:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup GitHub directories
        run: |
          mkdir -p .github/ISSUE_TEMPLATE
          mkdir -p .github/pull_request_template

      - name: Download PR Template
        if: github.event.client_payload.pr_template_updated == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const response = await github.rest.repos.getContent({
              owner: 'hubspotdev',
              repo: 'CODE-Hub',
              path: 'PR-Template.md',
              ref: 'main'
            });

            const content = Buffer.from(response.data.content, 'base64').toString();
            const fs = require('fs');

            // Write to both possible locations for pull request templates
            fs.writeFileSync('.github/pull_request_template.md', content);
            fs.writeFileSync('.github/PULL_REQUEST_TEMPLATE.md', content);

      - name: Download Bug Template
        if: github.event.client_payload.bug_template_updated == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const response = await github.rest.repos.getContent({
              owner: 'hubspotdev',
              repo: 'CODE-Hub',
              path: 'Bug-Issue-Template.md',
              ref: 'main'
            });

            const content = Buffer.from(response.data.content, 'base64').toString();
            const fs = require('fs');

            fs.writeFileSync('.github/ISSUE_TEMPLATE/bug_report.md', content);

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add .github/

          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update GitHub templates from CODE-Hub"
            git push
          fi
